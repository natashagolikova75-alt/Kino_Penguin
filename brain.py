import numpy as np
from sklearn.neural_network import MLPClassifier
from sklearn.feature_extraction.text import TfidfVectorizer
import warnings
warnings.filterwarnings("ignore")

class PenguinCinemaAI:
    def __init__(self):
        # База знаний для кинотеатра "Kino Penguin"
        self.data_source = {
            "films": [
                "фильмы", "кино", "что идет", "расписание", "афиша",
                "новинки", "посмотреть кино", "репертуар", "программа",
                "что показывают", "сеансы", "сегодня в кино", "завтра в кино",
                "идущие фильмы", "в прокате", "сейчас в кино", "репертуар кино",
                "какие фильмы есть", "список фильмов", "что сейчас идет"
            ],
            "genres": [
                "боевик", "комедия", "драма", "фантастика", "ужасы",
                "триллер", "детектив", "мелодрама", "мультфильм",
                "приключения", "семейный", "исторический", "фэнтези",
                "научная фантастика", "криминал", "биография", "вестерн",
                "музыкальный", "спорт", "документальный"
            ],
            "tickets": [
                "билеты", "купить билет", "стоимость", "цена", "бронирование",
                "забронировать", "заказ билетов", "онлайн покупка",
                "сколько стоит", "заказать билет", "оформить билет",
                "приобрести билет", "цена билета", "стоимость билетов",
                "оплата билетов", "бронь мест", "забронировать места"
            ],
            "cinema_info": [
                "кинотеатр", "адрес", "контакты", "телефон", "как добраться",
                "расположение", "о нас", "информация о кинотеатре",
                "где находитесь", "контактная информация", "кино пингвин",
                "kino penguin", "о кинотеатре", "про кинотеатр",
                "где находится кинотеатр", "адрес кинотеатра", "телефон кинотеатра"
            ],
            "sessions": [
                "сеансы", "расписание", "во сколько", "время сеансов",
                "сегодня показывают", "расписание на сегодня",
                "расписание на завтра", "время показа", "расписание сеансов",
                "сеансы на сегодня", "сеансы на завтра", "когда показывают",
                "во сколько сеансы", "график работы", "время работы кинотеатра"
            ],
            "help": [
                "помощь", "справка", "как пользоваться", "инструкция",
                "что ты умеешь", "возможности", "команды", "как работать",
                "информация", "подсказка", "как пользоваться ботом",
                "что можно сделать", "функции бота"
            ],
            "prices": [
                "цены", "стоимость", "сколько стоит билет", "цена билета",
                "льготы", "скидки", "акции", "специальные предложения",
                "студенческий билет", "пенсионерам", "детский билет",
                "утренние сеансы", "вечерние сеансы", "цены на билеты",
                "дешевые билеты"
            ],
            "halls": [
                "залы", "какой зал", "типы залов", "2d", "3d", "imax",
                "vip зал", "комфорт зал", "большой зал", "малый зал",
                "технологии", "звук", "качество изображения", "dolby atmos",
                "4k", "форматы показа"
            ],
            "small_talk": [
                "привет", "здравствуй", "добрый день", "здравствуйте",
                "как дела", "спасибо", "пока", "до свидания", "хорошо",
                "приветик", "доброе утро", "добрый вечер", "здорово",
                "отлично", "супер", "класс", "спс", "ок", "понятно"
            ]
        }
        
        self.corpus = []
        self.labels = []
        
        for intent, phrases in self.data_source.items():
            for phrase in phrases:
                self.corpus.append(phrase)
                self.labels.append(intent)
        
        # Векторизация текста с использованием символьных n-грамм
        self.vectorizer = TfidfVectorizer(analyzer='char_wb', ngram_range=(2, 4))
        X = self.vectorizer.fit_transform(self.corpus)
        
        # Нейросеть (многослойный перцептрон)
        self.clf = MLPClassifier(
            hidden_layer_sizes=(128, 64),
            max_iter=1500,
            random_state=42,
            activation='relu',
            solver='adam',
            alpha=0.001,
            learning_rate='adaptive'
        )
        
        self.clf.fit(X, self.labels)
        print(f"Нейросеть для 'Kino Penguin' обучена на {len(self.corpus)} примерах")
    
    def predict(self, text):
        """Возвращает (intent, probability)"""
        try:
            text_vec = self.vectorizer.transform([text.lower()])
            probs = self.clf.predict_proba(text_vec)[0]
            max_prob_idx = np.argmax(probs)
            max_prob = probs[max_prob_idx]
            predicted_label = self.clf.classes_[max_prob_idx]
            
            # Если текст не содержит известных паттернов или уверенность низкая
            if text_vec.nnz == 0 or max_prob < 0.25:
                return "unknown", 0.0
            
            return predicted_label, max_prob
        
        except Exception as e:
            print(f"Ошибка нейросети: {e}")
            return "unknown", 0.0

# Создаем глобальный объект нейросети
brain = PenguinCinemaAI()

# Тестирование нейросети
if __name__ == "__main__":
    test_queries = [
        "какие фильмы идут",
        "сколько стоит билет",
        "адрес кинотеатра",
        "расписание на сегодня",
        "привет",
        "боевики",
        "как доехать до кинотеатра",
        "есть ли скидки для студентов"
    ]
    
    for query in test_queries:
        intent, confidence = brain.predict(query)
        print(f"Запрос: '{query}' -> Намерение: {intent} (уверенность: {confidence:.2f})")